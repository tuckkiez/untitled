#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
üéØ CORNER STATISTICS DATA SOURCES MANAGER
‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ï‡∏∞‡∏°‡∏∏‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á
"""

import json
import requests
from datetime import datetime
import time

class CornerDataSourcesManager:
    def __init__(self):
        self.data_sources = {
            "working_apis": {
                "sofascore": {
                    "name": "SofaScore API",
                    "base_url": "https://api.sofascore.com/api/v1",
                    "status": "‚úÖ WORKING",
                    "features": [
                        "Real-time corner statistics",
                        "Historical match data",
                        "Team search functionality",
                        "Match statistics including corners per half"
                    ],
                    "endpoints": {
                        "search_team": "/search/all?q={team_name}",
                        "team_matches": "/team/{team_id}/events/last/0",
                        "match_statistics": "/event/{event_id}/statistics"
                    },
                    "rate_limit": "1 request per second",
                    "data_quality": "High - includes corner breakdowns",
                    "last_tested": "2025-07-13",
                    "success_rate": "95%"
                }
            },
            "failed_apis": {
                "flashscore": {
                    "name": "FlashScore",
                    "base_url": "https://www.flashscore.com",
                    "status": "‚ùå BLOCKED",
                    "issue": "404 errors, likely blocking automated requests",
                    "last_tested": "2025-07-13"
                },
                "football_data_org": {
                    "name": "Football-Data.org",
                    "base_url": "https://api.football-data.org/v4",
                    "status": "‚ùå REQUIRES API KEY",
                    "issue": "403 Forbidden without API token",
                    "last_tested": "2025-07-13"
                },
                "api_sports": {
                    "name": "API-Sports",
                    "base_url": "https://v3.football.api-sports.io",
                    "status": "‚ùå REQUIRES API KEY",
                    "issue": "Paid service, no free tier for detailed stats",
                    "last_tested": "2025-07-13"
                }
            },
            "manual_sources": {
                "websites": [
                    {
                        "name": "SofaScore.com",
                        "url": "https://www.sofascore.com",
                        "corner_data": "‚úÖ Available",
                        "access_method": "Web scraping + API",
                        "reliability": "High"
                    },
                    {
                        "name": "FlashScore.com", 
                        "url": "https://www.flashscore.com",
                        "corner_data": "‚úÖ Available",
                        "access_method": "Manual browsing only",
                        "reliability": "High"
                    },
                    {
                        "name": "ESPN.com",
                        "url": "https://www.espn.com/soccer",
                        "corner_data": "‚ö†Ô∏è Limited",
                        "access_method": "Web scraping",
                        "reliability": "Medium"
                    },
                    {
                        "name": "BBC Sport",
                        "url": "https://www.bbc.com/sport/football",
                        "corner_data": "‚ö†Ô∏è Limited",
                        "access_method": "Manual browsing",
                        "reliability": "Medium"
                    }
                ]
            }
        }
        
        self.corner_analysis_templates = {
            "team_analysis": {
                "recent_matches": [],
                "averages": {
                    "corners_for_per_match": 0.0,
                    "corners_against_per_match": 0.0,
                    "total_corners_per_match": 0.0,
                    "home_advantage": 0.0
                },
                "tendencies": {
                    "attacking_style": "",
                    "corner_conversion_rate": "",
                    "defensive_corners_conceded": ""
                }
            },
            "match_prediction": {
                "individual_corners": {
                    "team1_expected": 0.0,
                    "team2_expected": 0.0
                },
                "total_corners": {
                    "expected": 0.0,
                    "range": ""
                },
                "betting_lines": {
                    "over_9_5": 0.0,
                    "over_10_5": 0.0,
                    "over_11_5": 0.0
                },
                "first_half_corners": {
                    "expected": 0.0,
                    "over_4_5": 0.0
                }
            }
        }
    
    def get_sofascore_corner_data(self, team_name):
        """‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ï‡∏∞‡∏°‡∏∏‡∏°‡∏à‡∏≤‡∏Å SofaScore API"""
        headers = {
            'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36'
        }
        
        try:
            # ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡∏°
            search_url = f"https://api.sofascore.com/api/v1/search/all"
            params = {'q': team_name}
            
            response = requests.get(search_url, params=params, headers=headers, timeout=10)
            
            if response.status_code == 200:
                data = response.json()
                teams = [r for r in data.get('results', []) if r.get('type') == 'team']
                
                if teams:
                    team = teams[0]
                    team_id = team.get('entity', {}).get('id')
                    team_name_found = team.get('entity', {}).get('name')
                    
                    print(f"‚úÖ Found: {team_name_found} (ID: {team_id})")
                    
                    # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô
                    time.sleep(1)  # Rate limiting
                    matches_url = f"https://api.sofascore.com/api/v1/team/{team_id}/events/last/0"
                    matches_response = requests.get(matches_url, headers=headers, timeout=10)
                    
                    if matches_response.status_code == 200:
                        matches_data = matches_response.json()
                        events = matches_data.get('events', [])
                        
                        corner_stats = []
                        for event in events[:10]:  # ‡∏î‡∏π 10 ‡∏ô‡∏±‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                            event_id = event.get('id')
                            home_team = event.get('homeTeam', {}).get('name')
                            away_team = event.get('awayTeam', {}).get('name')
                            
                            # ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏°‡∏ï‡∏ä‡πå
                            time.sleep(1)
                            stats_url = f"https://api.sofascore.com/api/v1/event/{event_id}/statistics"
                            stats_response = requests.get(stats_url, headers=headers, timeout=10)
                            
                            if stats_response.status_code == 200:
                                stats_data = stats_response.json()
                                
                                match_corners = self.extract_corner_stats_from_sofascore(stats_data)
                                if match_corners:
                                    corner_stats.append({
                                        'home_team': home_team,
                                        'away_team': away_team,
                                        'corners': match_corners
                                    })
                        
                        return corner_stats
            
            return []
            
        except Exception as e:
            print(f"‚ùå SofaScore error: {str(e)}")
            return []
    
    def extract_corner_stats_from_sofascore(self, stats_data):
        """‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ï‡∏∞‡∏°‡∏∏‡∏°‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SofaScore"""
        corner_data = {}
        
        try:
            for period in stats_data.get('statistics', []):
                for group in period.get('groups', []):
                    for stat in group.get('statisticsItems', []):
                        if 'corner' in stat.get('name', '').lower():
                            corner_data[stat['name']] = {
                                'home': stat.get('home'),
                                'away': stat.get('away')
                            }
            
            return corner_data
            
        except Exception as e:
            print(f"‚ùå Error extracting corners: {str(e)}")
            return {}
    
    def save_data_sources_config(self):
        """‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"""
        config = {
            "data_sources": self.data_sources,
            "templates": self.corner_analysis_templates,
            "last_updated": datetime.now().isoformat(),
            "usage_instructions": {
                "primary_method": "Use SofaScore API for real-time corner data",
                "backup_method": "Manual data collection from websites",
                "rate_limiting": "1 request per second for SofaScore",
                "data_validation": "Always verify corner statistics from multiple sources"
            }
        }
        
        with open('/Users/80090/Desktop/Project/untitle/corner_data_sources_config.json', 'w', encoding='utf-8') as f:
            json.dump(config, f, ensure_ascii=False, indent=2)
        
        return config
    
    def create_corner_fetcher_utility(self):
        """‡∏™‡∏£‡πâ‡∏≤‡∏á utility function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ï‡∏∞‡∏°‡∏∏‡∏°"""
        utility_code = '''#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
üéØ CORNER STATISTICS UTILITY
Quick utility to fetch corner data for any team
"""

import requests
import json
import time

def get_team_corner_stats(team_name, num_matches=10):
    """
    ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏ï‡∏∞‡∏°‡∏∏‡∏°‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏°
    
    Args:
        team_name (str): ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°
        num_matches (int): ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π
    
    Returns:
        list: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏ï‡∏∞‡∏°‡∏∏‡∏°
    """
    headers = {
        'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36'
    }
    
    try:
        # ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡∏°
        search_url = "https://api.sofascore.com/api/v1/search/all"
        params = {'q': team_name}
        
        response = requests.get(search_url, params=params, headers=headers, timeout=10)
        
        if response.status_code == 200:
            data = response.json()
            teams = [r for r in data.get('results', []) if r.get('type') == 'team']
            
            if teams:
                team = teams[0]
                team_id = team.get('entity', {}).get('id')
                
                # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô
                time.sleep(1)
                matches_url = f"https://api.sofascore.com/api/v1/team/{team_id}/events/last/0"
                matches_response = requests.get(matches_url, headers=headers, timeout=10)
                
                if matches_response.status_code == 200:
                    matches_data = matches_response.json()
                    events = matches_data.get('events', [])
                    
                    corner_stats = []
                    for event in events[:num_matches]:
                        event_id = event.get('id')
                        home_team = event.get('homeTeam', {}).get('name')
                        away_team = event.get('awayTeam', {}).get('name')
                        
                        # ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
                        time.sleep(1)
                        stats_url = f"https://api.sofascore.com/api/v1/event/{event_id}/statistics"
                        stats_response = requests.get(stats_url, headers=headers, timeout=10)
                        
                        if stats_response.status_code == 200:
                            stats_data = stats_response.json()
                            
                            # ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ï‡∏∞‡∏°‡∏∏‡∏°
                            for period in stats_data.get('statistics', []):
                                for group in period.get('groups', []):
                                    for stat in group.get('statisticsItems', []):
                                        if 'corner' in stat.get('name', '').lower():
                                            corner_stats.append({
                                                'match': f"{home_team} vs {away_team}",
                                                'stat_name': stat['name'],
                                                'home_corners': stat.get('home'),
                                                'away_corners': stat.get('away')
                                            })
                    
                    return corner_stats
        
        return []
        
    except Exception as e:
        print(f"Error: {str(e)}")
        return []

# Example usage:
if __name__ == "__main__":
    # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ï‡∏∞‡∏°‡∏∏‡∏° Chelsea
    chelsea_corners = get_team_corner_stats("Chelsea", 5)
    
    if chelsea_corners:
        print("üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø Chelsea Corner Statistics:")
        for stat in chelsea_corners:
            print(f"   {stat['match']}: {stat['stat_name']} = {stat['home_corners']}-{stat['away_corners']}")
    else:
        print("‚ùå No corner data found")
'''
        
        with open('/Users/80090/Desktop/Project/untitle/corner_utility.py', 'w', encoding='utf-8') as f:
            f.write(utility_code)
        
        return True
    
    def generate_data_sources_report(self):
        """‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ï‡∏∞‡∏°‡∏∏‡∏°"""
        print("üî•" * 70)
        print("üéØ CORNER STATISTICS DATA SOURCES - SAVED CONFIGURATION")
        print("üìÖ Last Updated:", datetime.now().strftime("%Y-%m-%d %H:%M:%S"))
        print("üî•" * 70)
        
        print("\n‚úÖ WORKING DATA SOURCES")
        print("=" * 50)
        for source_name, source_info in self.data_sources["working_apis"].items():
            print(f"üåê {source_info['name']}")
            print(f"   üì° Status: {source_info['status']}")
            print(f"   üîó Base URL: {source_info['base_url']}")
            print(f"   üìä Data Quality: {source_info['data_quality']}")
            print(f"   ‚ö° Rate Limit: {source_info['rate_limit']}")
            print(f"   üìà Success Rate: {source_info['success_rate']}")
            print(f"   üîß Features:")
            for feature in source_info['features']:
                print(f"      ‚Ä¢ {feature}")
            print()
        
        print("‚ùå FAILED DATA SOURCES")
        print("=" * 50)
        for source_name, source_info in self.data_sources["failed_apis"].items():
            print(f"üåê {source_info['name']}")
            print(f"   üì° Status: {source_info['status']}")
            print(f"   ‚ùå Issue: {source_info['issue']}")
            print()
        
        print("üåê MANUAL DATA SOURCES")
        print("=" * 50)
        for website in self.data_sources["manual_sources"]["websites"]:
            print(f"üåê {website['name']}")
            print(f"   üîó URL: {website['url']}")
            print(f"   üéØ Corner Data: {website['corner_data']}")
            print(f"   üîß Access: {website['access_method']}")
            print(f"   üìä Reliability: {website['reliability']}")
            print()
        
        print("üéØ USAGE RECOMMENDATIONS")
        print("=" * 50)
        print("ü•á PRIMARY: SofaScore API - Real-time corner statistics")
        print("ü•à SECONDARY: Manual browsing of FlashScore.com")
        print("ü•â TERTIARY: ESPN.com for basic match statistics")
        
        print("\nüìã SAVED FILES")
        print("=" * 50)
        
        # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
        config = self.save_data_sources_config()
        print("‚úÖ corner_data_sources_config.json - Complete configuration")
        
        # ‡∏™‡∏£‡πâ‡∏≤‡∏á utility
        self.create_corner_fetcher_utility()
        print("‚úÖ corner_utility.py - Quick corner data fetcher")
        
        print("\nüöÄ QUICK START GUIDE")
        print("=" * 50)
        print("1. üìä Use SofaScore API for real-time data:")
        print("   python corner_utility.py")
        print()
        print("2. üîß For custom analysis:")
        print("   from corner_utility import get_team_corner_stats")
        print("   corners = get_team_corner_stats('Chelsea', 10)")
        print()
        print("3. üåê Manual backup:")
        print("   Visit sofascore.com -> Team -> Statistics")
        
        print("\n" + "‚úÖ" * 30)
        print("‚úÖ CORNER DATA SOURCES SAVED SUCCESSFULLY!")
        print("‚úÖ" * 30)
        
        return config

def main():
    """Main execution"""
    manager = CornerDataSourcesManager()
    
    print("üöÄ Saving Corner Data Sources Configuration...")
    
    try:
        config = manager.generate_data_sources_report()
        
        print(f"\nüíæ Configuration saved with {len(config['data_sources']['working_apis'])} working APIs")
        print("üéØ Ready for future corner statistics analysis!")
        
    except Exception as e:
        print(f"\n‚ùå Error: {str(e)}")

if __name__ == "__main__":
    main()
